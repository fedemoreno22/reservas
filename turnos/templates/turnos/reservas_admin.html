{% extends 'turnos/base.html' %}
{% load static %}

{% block title %}Reservas (Admin){% endblock %}

{% block content %}
<div class="container my-4">
  <form method="get" class="row g-3 mb-4">
    <div class="col-auto">
      <input type="date" name="fecha" class="form-control" value="{{ fecha }}">
    </div>
    <div class="col-auto">
      <select name="cancha" class="form-select">
        <option value="">Todas las canchas</option>
        {% for cancha in canchas %}
          <option value="{{ cancha.id }}" {% if cancha.id|stringformat:"s" == cancha_id %}selected{% endif %}>
            {{ cancha.nombre }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <select name="usuario" class="form-select">
        <option value="">Todos los clientes</option>
        {% for u in usuarios %}
          <option value="{{ u.id }}" {% if u.id|stringformat:"s" == usuario_id %}selected{% endif %}>
            {{ u.username }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">Filtrar</button>
      <a href="{% url 'reservar_turno' %}" class="btn btn-success">Reservar</a>
    </div>
</form>

<div class="table-responsive d-none d-md-block">
  <table class="table table-striped">
    <thead class="table-dark">
      <tr>
        <th>Cliente</th>
        <th>Cancha</th>
        <th>Fecha</th>
        <th>Hora inicio</th>
        <th>Hora fin</th>
        <th class="text-center">Acción</th>
      </tr>
    </thead>
    <tbody>
      {% for reserva in reservas %}
      <tr>
        <td>
          {% if reserva.nombre_cliente %}
            {{ reserva.nombre_cliente }}
          {% elif reserva.usuario %}
            {{ reserva.usuario.get_full_name|default:reserva.usuario.username }}
          {% else %}
            <em>Sin cliente</em>
          {% endif %}
        </td>      
        <td>{{ reserva.cancha.nombre }}</td>
        <td>{{ reserva.fecha|date:"d/m/Y" }}</td>
        <td>{{ reserva.hora_inicio }}</td>
        <td>{{ reserva.hora_fin }}</td>
        <td class="text-center">
          <form method="post" action="{% url 'cancelar_reserva' reserva.id %}" onsubmit="return confirmarCancelacion();">
            {% csrf_token %}
            <a href="{% url 'editar_reserva' reserva.id %}" class="btn btn-sm btn-warning">Editar</a>
            <button type="submit" class="btn btn-sm btn-danger">Cancelar</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Vista móvil -->
  <div class="d-md-none">
      {% for reserva in reservas %}
      <div class="card mb-3 shadow-sm border-0 rounded-3">
          <div class="card-body p-3">
              <h5 class="card-title mb-1">{{ reserva.cancha.nombre }}</h5>
              <p class="mb-1"><strong>Fecha:</strong> {{ reserva.fecha|date:"d/m/Y" }}</p>
              <p class="mb-1"><strong>Hora:</strong> {{ reserva.hora_inicio|time:"H:i" }} - {{ reserva.hora_fin|time:"H:i" }}</p>
              <p class="mb-2"><strong>Cliente:</strong>
                  {% if reserva.nombre_cliente %}
                      {{ reserva.nombre_cliente }}
                  {% elif reserva.usuario %}
                      {{ reserva.usuario.username }}
                  {% else %}
                      -
                  {% endif %}
              </p>
              <div class="d-flex justify-content-between">
                  <a href="{% url 'editar_reserva' reserva.id %}" class="btn btn-warning btn-sm">Editar</a>
                  <button type="submit" class="btn btn-sm btn-danger">Cancelar</button>
              </div>
          </div>
      </div>
      {% empty %}
      <p class="text-muted">No hay reservas registradas.</p>
      {% endfor %}
  </div>
</div>


{% endblock %}
